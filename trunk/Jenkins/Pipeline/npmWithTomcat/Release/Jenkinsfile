node ('jenkins-slave-01') {
  try {
    stage ('Code Checkout') {
      stage = "Code Checkout"
      checkout([
      $class: 'SubversionSCM',
      additionalCredentials: [],
      excludedCommitMessages: '',
      excludedRegions: '',
      excludedRevprop: '',
      excludedUsers: '',
      filterChangelog: false,
      ignoreDirPropChanges: false,
      includedRegions: '',
      locations: [[cancelProcessOnExternalsFail: true, 
        credentialsId: "$SCM_Cred_ID", 
        depthOption: 'infinity', 
        ignoreExternalsOption: true, 
        local: '.', 
        remote: '$SCM_checkout']], 
      quietOperation: true, workspaceUpdater: [$class: 'CheckoutUpdater']])
    }
	//stage ('Code Coverage') {
    //  stage = "Code Coverage"
    //  sh '''
	//  npm i
    //  '''
   //   }
 // stage ('UnitTest') {
  //    stage = "UnitTest"
  //    sh '''
 //	  npm i
  //    ''' 
   //  }
    stage('StaticAnalysis') {
     stage = "StaticAnalysis"
    withSonarQubeEnv('sonar') {
      sh '/opt/sonar/sonar-scanner-4.2.0.1873-linux_client/bin/sonar-scanner -Dsonar.projectBaseDir=. -Dsonar.projectKey="$sonarprojectName"  -Dsonar.projectName="$sonarprojectName" -Dsonar.host.url="$sonarhosturl" -Dsonar.login="$sonarlogin" -Dsonar.password="$sonarpassword" -Dsonar.scm.enabled=true -Dsonar.scm.provider=svn -Dsonar.svn.username="$sonarsvnusername" -Dsonar.svn.password.secured="$sonarsvnpasswordsecured" -Dsonar.java.binaries=target/classes -Dsonar.junit.reportsPath=target/surefire-reports -Dsonar.jacoco.reportPath=target/jacoco.exec -Dsonar.cobertura.reportPath=target/site/jacoco/jacoco.xml'
    } // submitted SonarQube taskId is automatically attached to the pipeline context1
  }
  
  // No need to occupy a node
  //stage("Quality Gate"){
  //stage = "Quality Gate"
  //timeout(time: 1, unit: 'HOURS') { // Just in case something goes wrong, pipeline will be killed after a timeout
   // def qg = waitForQualityGate() // Reuse taskId previously collected by withSonarQubeEnv
   // echo "qg"
	//if (qg.status != 'OK') {
     // error "Pipeline aborted due to quality gate failure: ${qg.status}"
    //}
  //}
    stage ('Package') {
      stage = "Package"
      sh '''
	  npm i
	  ng build --prod
	  '''
    }

    stage ('Deploy to QA') {
     sh '''
  /usr/bin/ansible-playbook -i $hostspath $ansibleplaybook --e ansiblehosts="${ansiblehosts}" -e win_service="${win_service}" -e   src="${src}" -e dest="${dest}"
     '''  
    }
    stage ('SanityTesting') {
      stage = "SanityTesting"
      build "$Sanity"
    }
    stage ('OWASP top10 SecVal') {
      stage = "OWASP top10 SecVal"
      sh """
/usr/bin/python /opt/job_jira_creation.py "${env.JOB_NAME}" "${env.BUILD_URL}" "${stage}" "${currentBuild.result}" "$JIRA_Prefix"  "$JIRA_Postfix" "$JIRA_Company_Code" "$Application_url" "$Application_url"
"""
    }
    stage ('Software Binaries Repo') {
      stage = "Software Binaries Repo"
withCredentials([usernamePassword(credentialsId: 'artifactoryId', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]) {
sh '''
cd /opt/jenkins/workspace/Proj_QA_TrinityIoT-OpsAdmin_pipe_Build_Release/dist/
tar -cvzf IoTOpsApps.tar.gz IoTOpsApps
curl -v -u $USERNAME:$PASSWORD --upload-file IoTOpsApps.tar.gz http://test.trinityiot.in:8081/repository/trinityIoTPlatform-Product/QA/Release/trinityIOTOps/"$(date +"%d-%m-%Y")"/IoTOpsApps.tar.gz
curl -v -u $USERNAME:$PASSWORD --upload-file IoTOpsApps.tar.gz http://test.trinityiot.in:8081/repository/trinityIoTPlatform-Product/QA/latest/trinityIOTOps/IoTOpsApps.tar.gz
'''
}
}
    currentBuild.result = 'SUCCESS'
  }
    catch (err) { currentBuild.result = 'FAILURE' }
finally {
    stage ('Report To JIRA')
{
      sh """
python /opt/job_jira_creation.py "${env.JOB_NAME}" "${env.BUILD_URL}" "${stage}" "${currentBuild.result}" "${JIRA_Prefix}" "${JIRA_Postfix}" "${JIRA_Company_Code}" "${Application_url}"
"""
}
    stage ('Send Email') {
      emailext (
        subject: "Status of ICCC-DevSecOps pipeline: ${currentBuild.fullDisplayName}& ${stage}",
        body: """${env.BUILD_URL} has result ${currentBuild.result} & at pipeline stage "${stage}" And Application url: ${Application_url} and sonarQube Url:${Sonarqube_url} \n\n\n\n  \n\nNote:This is an autogenerated mail.\nIn case of any clarification Please check with bhargava.t@trinitymobility.com or anas@trinitymobility.com""",
        to: 'bhargava.t@trinitymobility.com,anilkumar@trinitymobility.com,veera@trinitymobility.com,anas@trinitymobility.com,sabjan.p@trinitymobility.com,narasimhamurthy.tn@trinitymobility.com,mahidhar@trinitymobility.com' )
    }
 //stage ('cleanws'){
 //  cleanWs() 
//}   
}
}
